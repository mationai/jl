// Generated by CoffeeScript 1.3.3
(function(){"Living code in documents\n\ngeneralises coding.js for multiple languages\nalso name-spaces it\n\ndependiences:\n  scheme: BiwaScheme\n  javascript: SandboxJS - https://github.com/TooTallNate/SandboxJS";var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E={}.hasOwnProperty,S=function(e,t){function r(){this.constructor=e}for(var n in t)E.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};return f="livecode",h="running",i=!1,m={},i?(y=function(){return console.log.apply(console,arguments)},w=function(){return console.group.apply(console,arguments)},b=function(){return console.groupEnd.apply(console,arguments)}):y=w=b=function(){},e=function(e){return $(document.createElement(e))},t=function(e){return $(e).get(0)},g=function(e,t){return e[t]!==void 0},v=function(){function e(e){var t,n;this.key_value={},this.value_key={};if(e!=null){this.key_value=e;for(t in e)n=e[t],this.value_key[n]=t}}return e.prototype.contains=function(e){return g(this.key_value,e)||g(this.value_key,e)},e.prototype.assoc=function(e,t){return this.key_value[e]=t,this.value_key[t]=e},e.prototype.get=function(e){var t,n;return n=this.key_value[e],t=this.value_key[e],n!=null?n:t},e}(),d=function(){function e(e){var t,n,r;this.dict={};if(e!=null)for(n=0,r=e.length;n<r;n++)t=e[n],this.add(t)}return e.prototype.add=function(e){return this.dict[e]=!0},e.prototype.remove=function(e){return delete this.dict[e],e},e.prototype.contains=function(e){return this.dict[e]!==void 0},e}(),u=function(){function n(){this.__id=e()}var e,t;return t=0,e=function(){return t+=1,"#"+t},n.prototype.toString=function(){return""+this.constructor.name+"<"+this.__id+">"},n}(),r=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return S(t,e),t.prototype.eval=function(e){return y("evaling code in context",this,e),e},t.prototype.toString=function(){return"Context:"+t.__super__.toString.call(this)},t}(u),a=function(e){function t(){t.__super__.constructor.call(this),this.ctx=new Sandbox(!0)}return S(t,e),t.prototype.eval=function(e){e=t.__super__.eval.call(this,e);try{return JSON.stringify(this.ctx.eval(e))}catch(n){return n.toString()}},t}(r),o=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}var t;return S(n,e),t=$("<iframe seamless></iframe>").css({width:"100%",height:"100%"}),n.prototype.eval=function(e){var n;return n=window.latest_frame=t.clone().load(function(){var t;return t=this.contentDocument||this.contentWindow.document,t.open(),t.write(e),t.close(),$(this).height(t.body.scrollHeight)}),n},n}(r),m.languages={javascript:{name:"javascript",context:a},html:{name:"text/html",context:o}},n=function(e){function t(e,n,r,i,o,u){var a,f,l,c=this;this.language_name=n,this.context=r,t.__super__.constructor.call(this),$(e).addClass(h),this.depended_on_by=[],this.dependencies=[],this.current_evaluation_contexts=new d;if(i!=null)for(f=0,l=i.length;f<l;f++)a=i[f],this.addDep(a);this.editor=new s(e,this.language_name,o,u),this.editor.addChangeCallback(function(){return c.eval()})}return S(t,e),t.prototype.eval=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d;n=e||this.context,w("Codeblock Evaluation",this.toString(),n.toString());if(this.current_evaluation_contexts.contains(n)){y("eval aborted: already evaled in this context"),b();return}this.current_evaluation_contexts.add(n);if(this.dependencies!=null){c=this.dependencies;for(s=0,a=c.length;s<a;s++)r=c[s],r.eval(n)}i=n.eval(this.getCode());if(this.depended_on_by!=null){h=this.depended_on_by;for(o=0,f=h.length;o<f;o++)r=h[o],r.eval()}this.current_evaluation_contexts.remove(n);if(this.callbacks!=null){p=this.callbacks;for(u=0,l=p.length;u<l;u++)t=p[u],t[0].call((d=t[1])!=null?d:null,i,this)}return b(),i},t.prototype.getCode=function(){return this.editor.getCode()},t.prototype.addCallback=function(e,t){return this.callbacks!=null?this.callbacks.push([e,t]):this.callbacks=[[e,t]]},t.prototype.addDep=function(e){return y("adding dep",e),this.dependencies.push(e),e.depended_on_by.push(this)},t}(u),s=function(){function e(e,t,n,r){var i,s,o,u=this;this.changeCallbacks=[],i=$(e),y("Editor init",e,t),s=i.get(0).innerHTML,s=s.replace(/^\n/,"").replace(/\n*$/,"").replace(/[ \t]*\n/g,"\n").replace(/\s*$/,""),i.empty(),o=CodeMirror(i[0],{value:s,mode:t,onBlur:function(){var e,t,n,r,i;y("Editor.onBlur",u),r=u.changeCallbacks,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(e(o.getValue(),u));return i}}),o.setOption("cursorBlinkRate",460),o.setOption("cursorHeight",1.2),o.setOption("lineWrapping",!0),n&&!i.hasClass("hide")&&n.call(r,o),this.editor=o}return e.prototype.getCode=function(){var e=this.editor.getValue(),t=/^\s*var\s+/;return e.indexOf("emptyCan")==-1&&(e=e.replace(t,"")),e.replace(/\s*\/\/((?!\n).)*\n/g,";")},e.prototype.addChangeCallback=function(e){return this.changeCallbacks.push(e)},e}(),c=function(e){function t(e,t){this.codeblock=t,y("OutputWindow init",e,this.codeblock),this.node=$(e).addClass(""+h+" output"),this.codeblock.addCallback(this.updateCallback,this)}return S(t,e),t.prototype.updateCallback=function(e){this.node.trigger("evaluate",[e,this.codeblock])},t}(u),p=function(){function e(){var e,t,n;this.languageControllers={},n=m.languages;for(t in n)e=n[t],this.languageControllers[t]=new l(e)}return e.prototype.allBlocks=function(){var e,t,n,r;t=[],r=this.languageControllers;for(n in r)e=r[n],t=t.concat(e.blocks);return t},e.prototype.getNamedBlock=function(e){var t,n,r,i;i=this.languageControllers;for(r in i){n=i[r],t=n.namedBlocks.get(e);if(t!=null)return t}return void 0},e.prototype.scan=function(e,t,n){var r,i,s=this;return r=$(e).find("."+f+":not(."+h+", .output)"),r.each(function(e,r){var i,o,u,a;i=$(r),a=s.languageControllers;for(u in a){o=a[u];if(i.hasClass(u))return o.buildBlock(r,t,n)}}),i=$(e).find("."+f+".output:not(."+h+")"),i.each(function(e,t){return s.buildOutput(t)}),this},e.prototype.buildOutput=function(e){var t,n,r,i;t=$(e),y(e,"building output"),i=t.data("for");if(!i)throw Error("Script outputs must display results for a named editor");n=this.getNamedBlock(i);if(!n)throw Error("No living-script named "+i+" found");return r=new c(e,n)},e}(),l=function(){function r(e){this.language=e,this.Context=this.language.context,this.defaultContext=new this.Context,this.contexts=new v,this.namedBlocks=new v,this.blocks=[]}return r.prototype.buildBlock=function(r,i,s){var o,u,a,f,l,h,p,d,v=this;o=$(r),y(r,"building editor"),f=o.data("context"),f?this.contexts.contains(f)?a=this.contexts.get(f):(a=new this.Context,this.contexts.assoc(f,a)):a=this.defaultContext,l=o.data("dependsOn"),l&&(y("with dependency",l),l=l.split(" ").map(function(e){if(v.namedBlocks.contains(e))return v.namedBlocks.get(e);throw new Error("Named depencency "+e+" undefined for language "+v.language.name)})),y("deps",l),u=new n(r,this.language.name,a,l,i,s),this.blocks.push(u),o.hasClass("no-output")||(d=e("div").insertAfter(r),p=new c(t(d),u)),h=o.attr("id");if(h)return y("saved named editor",h,u),this.namedBlocks.assoc(h,u)},r}(),m.scan=function(e,t,n){return(new p).scan(e,t,n)},m.Context=r,m.JavascriptContext=a,m.Codeblock=n,m.Editor=s,m.OutputWindpw=c,m.Scanner=p,m.LanguageController=l,window.LiveCode=m,m}).call(this);